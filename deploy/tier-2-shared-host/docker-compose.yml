services:
  # The Offline Root service
  # Only start this to sign/renew/revoke intermediates.
  root-ca:
    build: ../..
    image: ssh-ca:latest
    container_name: ssh-ca-root
    ports:
      - "8081:8080"
    environment:
      - CA_MODE=offline
      - BIND_ADDR=:8080
      - KEY_PATH=/data/keys
      - DB_PATH=/data/ssh-ca.db
    # SECURITY TIP: Keep ROOT_DATA_DIR on an encrypted USB drive.
    # Only plug in the USB when you need to start this service.
    volumes:
      - ${ROOT_DATA_DIR:-/mnt/usb_ca/root-ca-data}:/data
    restart: "no"

  # The Online Intermediate service
  intermediate-ca:
    build: ../..
    image: ssh-ca:latest
    container_name: ssh-ca-online
    ports:
      - "8080:8080"
    environment:
      - CA_MODE=online
      - BIND_ADDR=:8080
      - KEY_PATH=/data/keys
      - DB_PATH=/data/ssh-ca.db
    volumes:
      - ${INTERMEDIATE_DATA_DIR:-./online-ca-data}:/data
    restart: unless-stopped
