FROM golang:1.24-alpine AS builder
WORKDIR /app
COPY go.mod go.sum* ./
RUN go mod download
COPY . .
RUN go build -o ssh-ca ./cmd/fenrir
RUN go build -o tyr ./cmd/tyr

FROM alpine:latest
RUN apk add --no-cache ca-certificates openssh-client curl bash jq bind-tools
WORKDIR /app
COPY --from=builder /app/ssh-ca .
COPY --from=builder /app/tyr .
COPY web/ ./web/
COPY scripts/ ./scripts/
COPY scripts/test-e2e-suite.sh ./test-e2e-suite.sh
RUN chmod +x ./test-e2e-suite.sh ./scripts/*.sh
RUN chmod +x ./test-e2e-suite.sh
CMD ["./ssh-ca"]
