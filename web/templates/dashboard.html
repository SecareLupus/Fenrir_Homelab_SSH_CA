{{define "content"}}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
        <h2 style="margin: 0; font-size: 1.5rem; letter-spacing: -0.02em;">Request Certificate</h2>
        {{if .IsAdmin}}
        <div style="display: flex; gap: 1.5rem; align-items: center;">
            <a href="/mfa/setup"
                style="color: var(--primary); text-decoration: none; font-size: 0.85rem; font-weight: 600;">Secure
                Account (MFA)</a>
            {{if eq .Mode "offline"}}
            <a href="/admin/offline"
                style="color: #fbbf24; text-decoration: none; font-size: 0.85rem; font-weight: 600;">Offline
                Management</a>
            {{else}}
            <a href="/admin/hosts/sign"
                style="color: var(--primary); text-decoration: none; font-size: 0.85rem; font-weight: 600;">Host
                Signing</a>
            {{end}}
            <a href="/admin/users"
                style="color: var(--primary); text-decoration: none; font-size: 0.85rem; font-weight: 600; background: rgba(59, 130, 246, 0.1); padding: 0.4rem 0.8rem; border-radius: 6px;">Admin
                Panel &rarr;</a>
        </div>
        {{end}}
    </div>
    <form id="cert-form" action="/cert/request" method="POST">
        <label for="pubkey">SSH Public Key</label>
        <textarea id="pubkey" name="pubkey" rows="4" placeholder="ssh-ed25519 AAAAC3..." required></textarea>

        <label for="principals">Principals (Optional)</label>
        <input type="text" id="principals" name="principals"
            placeholder="{{if .IsAdmin}}e.g. admin,pi,root{{else}}pi by default{{end}}" {{if not .IsAdmin}}readonly
            value="{{.User}}" {{end}} {{if not .IsAdmin}}style="background: rgba(255,255,255,0.02);"
            {{else}}style="background: var(--bg);" {{end}}>
        {{if .IsAdmin}}
        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: -0.75rem; margin-bottom: 1rem;">
            Comma-separated list of usernames this certificate can log in as.
        </p>
        {{end}}

        <label for="ttl">Validity Duration</label>
        <select id="ttl" name="ttl">
            <option value="3600">Short-lived (1 Hour)</option>
            <option value="28800">Standard (8 Hours)</option>
            <option value="86400">Long-lived (24 Hours)</option>
        </select>

        <button type="submit" id="sign-btn">Sign Certificate</button>
    </form>
</div>

<div id="cert-result" class="card"
    style="display: none; border-color: var(--success); background: rgba(16, 185, 129, 0.05);">
    <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--success);">Signed Certificate</h2>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Your certificate has been signed
        successfully. Copy the content below or download the file.</p>

    <label>Certificate Content</label>
    <textarea id="signed-cert" rows="6" readonly onclick="this.select()"
        style="font-family: monospace; font-size: 0.8rem; background: #0b0f1a; border-color: rgba(16, 185, 129, 0.3);"></textarea>

    <div style="display: flex; gap: 1rem;">
        <button id="download-btn" style="background: var(--success); flex: 1;">Download .pub file</button>
        <button onclick="document.getElementById('cert-result').style.display='none'"
            style="background: transparent; border: 1px solid var(--border); width: auto; padding: 0 1.5rem;">Close</button>
    </div>
</div>

<div class="card">
    <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem;">CA Public Keys</h2>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Add these to your server
        configuration to enable trust.</p>

    <label>User CA Key (TrustedUserCAKeys)</label>
    <div style="position: relative;">
        <input type="text" readonly value="{{.UserCAKey}}" onclick="this.select()"
            style="font-family: monospace; font-size: 0.8rem; padding-right: 3rem;">
        <span
            style="position: absolute; right: 1rem; top: 0.75rem; color: var(--text-muted); font-size: 0.7rem; pointer-events: none;">COPIABLE</span>
    </div>

    <label>Host CA Key (HostCertificate)</label>
    <div style="position: relative;">
        <input type="text" readonly value="{{.HostCAKey}}" onclick="this.select()"
            style="font-family: monospace; font-size: 0.8rem; padding-right: 3rem;">
        <span
            style="position: absolute; right: 1rem; top: 0.75rem; color: var(--text-muted); font-size: 0.7rem; pointer-events: none;">COPIABLE</span>
    </div>
</div>

<div class="card">
    <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem;">Server Setup (sshd_config)</h2>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Configure
        <code>/etc/ssh/sshd_config</code> to trust user certificates.
    </p>
    <pre
        style="background: #0b0f1a; padding: 1.25rem; border-radius: 8px; border: 1px solid var(--border); overflow-x: auto; font-size: 0.85rem; color: #94a3b8; line-height: 1.6;">
# 1. Trust users signed by this CA
TrustedUserCAKeys /etc/ssh/user_ca.pub

# 2. (Recommended) Set your host certificate
HostCertificate /etc/ssh/ssh_host_ed25519-cert.pub</pre>
    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem;">Save the <b>User CA Key</b> to
        <code>/etc/ssh/user_ca.pub</code> and restart sshd.
    </p>
</div>

<div class="card">
    <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem;">Security Keys (WebAuthn)</h2>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Add a hardware security key or
        passkey for passwordless login.</p>
    <button id="register-webauthn-btn"
        style="background: var(--surface); border: 1px solid var(--border); margin-top: 0;">Register New Security
        Key</button>
    <div id="webauthn-status" style="margin-top: 1rem; font-size: 0.85rem; display: none;"></div>
</div>

<div class="card">
    <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem;">API Keys</h2>
    {{if .NewAPIKey}}
    <div
        style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 8px;">
        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--success); font-size: 0.9rem;">New API Key
            Generated:</p>
        <code
            style="word-break: break-all; background: #0b0f1a; display: block; padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; border: 1px solid rgba(16, 185, 129, 0.2);">{{.NewAPIKey}}</code>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--text-muted);">This will not be shown again.
            Save it securely.</p>
    </div>
    {{end}}
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Use API keys to authenticate via the
        CLI tool.</p>
    <form action="/api/keys/generate" method="POST">
        <button type="submit"
            style="background: var(--surface); border: 1px solid var(--border); margin-top: 0;">Generate New API
            Key</button>
    </form>
</div>

{{if .IsAdmin}}
<div class="card">
    <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem;">Fleet Real-time Status</h2>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Live health and activity metrics from Gleipnir agents.</p>

    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; border-bottom: 1px solid var(--border);">
                    <th style="padding: 1rem; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">Hostname</th>
                    <th style="padding: 1rem; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">Load (1/5/15)</th>
                    <th style="padding: 1rem; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">SSH Sessions</th>
                    <th style="padding: 1rem; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">Last Seen</th>
                </tr>
            </thead>
            <tbody>
                {{range $host, $m := .HostMetrics}}
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 1rem; font-weight: 500;">{{$host}}</td>
                    <td style="padding: 1rem; font-family: monospace; font-size: 0.85rem;">
                        {{printf "%.2f" $m.Load1}} / {{printf "%.2f" $m.Load5}} / {{printf "%.2f" $m.Load15}}
                    </td>
                    <td style="padding: 1rem;">
                        <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">{{$m.ActiveSSH}} Active</span>
                    </td>
                    <td style="padding: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                        {{$m.LastReported.Format "15:04:05"}}
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-muted);">No metrics reported yet.</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{end}}

<script>
    document.getElementById('cert-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('sign-btn');
        const originalText = btn.innerText;

        btn.disabled = true;
        btn.innerText = 'Signing...';

        const formData = new FormData(form);
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            if (!response.ok) {
                const error = await response.text();
                alert('Error: ' + error);
                return;
            }

            const cert = await response.text();
            document.getElementById('signed-cert').value = cert;
            document.getElementById('cert-result').style.display = 'block';
            document.getElementById('cert-result').scrollIntoView({ behavior: 'smooth' });

            // Setup download
            const blob = new Blob([cert], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = 'id_ed25519-cert.pub';
                a.click();
            };
        } catch (err) {
            alert('Network error: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    });

    // WebAuthn Registration
    document.getElementById('register-webauthn-btn').addEventListener('click', async () => {
        const btn = document.getElementById('register-webauthn-btn');
        const status = document.getElementById('webauthn-status');

        status.style.display = 'block';
        status.innerText = 'Initializing...';
        status.style.color = 'var(--text-muted)';

        try {
            // 1. Get options from server
            const resp = await fetch('/webauthn/register/begin', { method: 'POST' });
            if (!resp.ok) throw new Error(await resp.text());
            const options = await resp.json();

            // 2. Decode base64 strings to ArrayBuffers
            options.publicKey.challenge = bufferDecode(options.publicKey.challenge);
            options.publicKey.user.id = bufferDecode(options.publicKey.user.id);
            if (options.publicKey.excludeCredentials) {
                options.publicKey.excludeCredentials.forEach(c => c.id = bufferDecode(c.id));
            }

            // 3. Create credential
            const credential = await navigator.credentials.create({
                publicKey: options.publicKey
            });

            // 4. Encode ArrayBuffers to base64
            const credentialForServer = {
                id: credential.id,
                rawId: bufferEncode(credential.rawId),
                type: credential.type,
                response: {
                    attestationObject: bufferEncode(credential.response.attestationObject),
                    clientDataJSON: bufferEncode(credential.response.clientDataJSON),
                },
            };

            // 5. Send back to server
            const finishResp = await fetch('/webauthn/register/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentialForServer)
            });

            if (!finishResp.ok) throw new Error(await finishResp.text());

            status.innerText = 'Security Key registered successfully!';
            status.style.color = 'var(--success)';
        } catch (err) {
            console.error(err);
            status.innerText = 'Error: ' + err.message;
            status.style.color = '#f87171';
        }
    });

    // Helper functions for WebAuthn encoding/decoding
    function bufferDecode(value) {
        return Uint8Array.from(atob(value.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));
    }

    function bufferEncode(value) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
            .replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
    }
</script>
{{end}}