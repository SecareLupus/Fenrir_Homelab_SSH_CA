<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyr Settings</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        :root {
            /* Material Design 3 Dark Theme Tokens */
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-error: #F2B8B5;
            --md-sys-color-success: #B4E1B5;

            --bg: var(--md-sys-color-surface);
            --text: var(--md-sys-color-on-surface);
            --text-muted: var(--md-sys-color-on-surface-variant);
        }

        * {
            box-sizing: border-box;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 600px;
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            padding: 2.5rem;
            position: relative;
        }

        h2 { margin: 0 0 2rem 0; font-size: 1.75rem; font-weight: 400; }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--md-sys-color-surface-variant);
            padding: 4px;
            border-radius: 99px;
        }

        .tab {
            flex: 1;
            padding: 0.6rem;
            text-align: center;
            cursor: pointer;
            border-radius: 99px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .tab.active {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .tab-content { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group { margin-bottom: 1.5rem; }
        label {
            display: block;
            font-size: 0.85rem;
            color: var(--md-sys-color-primary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input {
            width: 100%;
            background: transparent;
            border: 1px solid var(--md-sys-color-outline);
            padding: 0.9rem 1rem;
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            outline: none;
        }
        input:focus { border-color: var(--md-sys-color-primary); border-width: 2px; }

        .btn {
            background: var(--md-sys-color-primary);
            border: none;
            color: var(--md-sys-color-on-primary);
            padding: 1rem;
            border-radius: 99px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover { box-shadow: 0 1px 3px rgba(0,0,0,0.3); opacity: 0.9; }
        .btn-secondary { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); margin-top: 1.5rem; }

        .alert {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            text-align: center;
        }
        .alert-success { background: rgba(180, 225, 181, 0.15); color: var(--md-sys-color-success); border: 1px solid var(--md-sys-color-success); }
        .alert-error { background: rgba(242, 184, 181, 0.15); color: var(--md-sys-color-error); border: 1px solid var(--md-sys-color-error); }

        .back-link {
            position: absolute;
            top: 2rem; right: 2.5rem;
            color: var(--md-sys-color-primary);
            text-decoration: none;
            font-size: 0.85rem;
        }

        .step-indicator {
            display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1rem;
        }
        .step-dot { width: 8px; height: 8px; background: var(--md-sys-color-outline); border-radius: 50%; }
        .step-dot.active { background: var(--md-sys-color-primary); }

        [x-cloak] { display: none !important; }
    </style>
</head>

<body x-data="settings()" x-init="init()">
    <div class="container">
        <a href="/" class="back-link" x-show="!onboarding">← Dashboard</a>
        <h2 x-text="onboarding ? 'Getting Started' : 'Settings'"></h2>

        <template x-if="alert.message">
            <div class="alert" :class="'alert-' + alert.type" x-text="alert.message"></div>
        </template>

        <!-- Main Settings UI -->
        <div x-show="!onboarding" x-cloak>
            <div class="tabs">
                <div class="tab" :class="activeTab === 'login' ? 'active' : ''" @click="activeTab = 'login'">Login</div>
                <div class="tab" :class="activeTab === 'apikey' ? 'active' : ''" @click="activeTab = 'apikey'">API Key</div>
                <div class="tab" :class="activeTab === 'advanced' ? 'active' : ''" @click="activeTab = 'advanced'">Advanced</div>
            </div>

            <div class="tab-content" x-show="activeTab === 'login'">
                <div class="form-group">
                    <label>Fenrir Server URL</label>
                    <input type="text" x-model="config.server_url">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" x-model="login.username" placeholder="alice">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" x-model="login.password" placeholder="••••••••">
                </div>
                <div x-show="login.mfaRequired" x-cloak>
                    <div class="form-group">
                        <label>MFA Code</label>
                        <input type="text" x-model="login.mfaCode" placeholder="123456">
                    </div>
                </div>
                <button class="btn" @click="doLogin()">Authenticate</button>
            </div>

            <div class="tab-content" x-show="activeTab === 'apikey'">
                <div class="form-group">
                    <label>Fenrir Server URL</label>
                    <input type="text" x-model="config.server_url">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" x-model="config.api_key" :placeholder="config.has_api_key ? '(saved securely in keychain)' : 'Enter API key'">
                </div>
                <button class="btn" @click="saveAPIConfig()">Save API Configuration</button>
            </div>

            <div class="tab-content" x-show="activeTab === 'advanced'">
                <div class="form-group">
                    <label>SSH Key Path</label>
                    <input type="text" x-model="config.key_path">
                </div>
                <div class="form-group">
                    <label>Key Type</label>
                    <input type="text" x-model="config.key_type">
                </div>
                <button class="btn" @click="saveAdvanced()">Update Settings</button>
                <button class="btn btn-secondary" @click="clearConfig()">Clear All Configurations</button>
            </div>
        </div>

        <!-- Onboarding Wizard -->
        <div x-show="onboarding" x-cloak>
            <div class="step-indicator">
                <div class="step-dot" :class="step === 1 ? 'active' : ''"></div>
                <div class="step-dot" :class="step === 2 ? 'active' : ''"></div>
                <div class="step-dot" :class="step === 3 ? 'active' : ''"></div>
            </div>

            <div x-show="step === 1" class="tab-content">
                <p style="margin-bottom: 2rem; color: var(--text-muted);">Welcome to Tyr! First, enter your Fenrir server URL.</p>
                <div class="form-group">
                    <label>Fenrir Server URL</label>
                    <input type="text" x-model="config.server_url" placeholder="http://fenrir.homelab:8080">
                </div>
                <button class="btn" @click="step = 2">Continue</button>
            </div>

            <div x-show="step === 2" class="tab-content">
                <p style="margin-bottom: 2rem; color: var(--text-muted);">Sign in to your account.</p>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" x-model="login.username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" x-model="login.password">
                </div>
                <div x-show="login.mfaRequired" x-cloak>
                    <div class="form-group">
                        <label>MFA Code</label>
                        <input type="text" x-model="login.mfaCode">
                    </div>
                </div>
                <button class="btn" @click="doLogin()">Sign In</button>
                <button class="btn btn-secondary" @click="step = 1" style="background: none; border: 1px solid var(--md-sys-color-outline);">Back</button>
            </div>

            <div x-show="step === 3" class="tab-content">
                <p style="margin-bottom: 2rem; color: var(--text-muted);">Everything is set up! Your credentials have been stored securely in your system's keychain.</p>
                <div class="form-group">
                    <label>SSH Key Location</label>
                    <input type="text" x-model="config.key_path" readonly style="opacity: 0.7;">
                </div>
                <button class="btn" @click="finishOnboarding()">Go to Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        function settings() {
            return {
                onboarding: false,
                step: 1,
                activeTab: 'login',
                config: {
                    server_url: '',
                    key_path: '',
                    key_type: '',
                    has_api_key: false,
                    api_key: ''
                },
                login: {
                    username: '',
                    password: '',
                    mfaCode: '',
                    mfaRequired: false
                },
                alert: { message: '', type: 'success' },

                async init() {
                    await this.loadConfig();
                    if (!this.config.server_url || !this.config.has_api_key) {
                        this.onboarding = true;
                    }
                },

                showAlert(msg, type = 'success') {
                    this.alert = { message: msg, type };
                    setTimeout(() => this.alert.message = '', 5000);
                },

                async loadConfig() {
                    try {
                        const resp = await fetch('/api/config');
                        this.config = await resp.json();
                    } catch (e) {}
                },

                async doLogin() {
                    try {
                        const resp = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                server_url: this.config.server_url,
                                username: this.login.username,
                                password: this.login.password,
                                mfa_code: this.login.mfaCode
                            })
                        });
                        const data = await resp.json();
                        if (data.mfa_required) {
                            this.login.mfaRequired = true;
                            this.showAlert('MFA required', 'warning');
                            return;
                        }
                        if (resp.ok) {
                            if (this.onboarding) {
                                this.step = 3;
                            } else {
                                this.showAlert('Authenticated successfully');
                                setTimeout(() => window.location.href = '/', 1000);
                            }
                        } else {
                            this.showAlert(data.error || 'Login failed', 'error');
                        }
                    } catch (e) {
                        this.showAlert('Connection error', 'error');
                    }
                },

                async saveAPIConfig() {
                    const resp = await fetch('/api/config', {
                        method: 'POST',
                        body: JSON.stringify({
                            server_url: this.config.server_url,
                            api_key: this.config.api_key
                        })
                    });
                    if (resp.ok) {
                        this.showAlert('Configuration saved');
                        setTimeout(() => window.location.href = '/', 1000);
                    }
                },

                async saveAdvanced() {
                    const resp = await fetch('/api/config/advanced', {
                        method: 'POST',
                        body: JSON.stringify({
                            key_path: this.config.key_path,
                            key_type: this.config.key_type
                        })
                    });
                    if (resp.ok) this.showAlert('Settings updated');
                },

                async clearConfig() {
                    if (confirm('Clear all settings?')) {
                        await fetch('/api/config', { method: 'DELETE' });
                        location.reload();
                    }
                },

                finishOnboarding() {
                    window.location.href = '/';
                }
            }
        }
    </script>
</body>

</html>