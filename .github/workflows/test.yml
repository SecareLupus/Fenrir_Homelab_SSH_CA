name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpam0g-dev \
            libp11-kit-dev \
            libglib2.0-dev \
            libayatana-appindicator3-dev \
            libgtk-3-dev \
            jq

      - name: Vet
        run: go vet ./...

      - name: Test
        run: go test -v -race ./...

      - name: E2E - Setup & Run
        env:
          CA_SERVER_URL: "http://localhost:8080"
          TARGET_HOST: "localhost"
          INITIAL_ADMIN_PASSWORD: "adminpassword"
          FENRIR_ENV: "testing"
        run: |
          set -e
          # 1. Build Fenrir
          go build -o fenrir ./cmd/fenrir
          go build -o tyr ./cmd/tyr

          # 2. Setup Env
          mkdir -p test_env/keys
          # Pre-generate CA keys so we can configure SSHD before starting server
          # Actually, fenrir generates them on startup. 
          # Let's start Fenrir in background, wait for health, THEN configure SSHD.

          # Start Fenrir
          ./fenrir --config ./config.yaml --mode testing &
          PID=$!

          # Wait for health
          echo "Waiting for Fenrir..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/api/v1/health; then
              echo "Fenrir is UP"
              break
            fi
            sleep 1
          done

          # 3. Configure Runner SSHD
          # Fetch User CA from running server
          curl -s http://localhost:8080/api/v1/ca/user > user_ca.pub

          # Add to SSHD config
          # GitHub Runners allow sudo. We need to enable TrustedUserCAKeys.
          sudo sh -c 'echo "TrustedUserCAKeys $(pwd)/user_ca.pub" >> /etc/ssh/sshd_config'
          # Ensure AuthorizedPrincipals is allowed? 
          # By default "AuthorizedPrincipalsFile none" means we rely on key validity?
          # Actually, standard TrustedUserCAKeys trusts the CA but we need to map principals to users.
          # For testing, we can use "AuthorizedPrincipalsFile none" and just rely on the cert being valid 
          # IF the cert principal matches the username.
          # The script uses "testuser". Runner user is "runner"?
          # We should create "testuser" on the runner or map "testuser" principal to current user.
          # Easier: Map principal "testuser" to current user "runner".
          # Add "AuthorizedPrincipalsFile /etc/ssh/auth_principals/%u"
          sudo sh -c 'echo "AuthorizedPrincipalsFile /etc/ssh/auth_principals/%u" >> /etc/ssh/sshd_config'
          sudo mkdir -p /etc/ssh/auth_principals
          sudo sh -c "echo 'testuser' > /etc/ssh/auth_principals/$(whoami)"

          # Restart SSHD
          sudo service ssh restart

          # 4. Run E2E Script
          # Override TARGET_HOST to localhost
          # Override CA_URL to localhost:8080
          # We also need to be able to SSH to localhost. 
          # Runner usually has NO public keys in authorized_keys, so cert auth is the only way (good).

          # The script expects 'testuser' connection. 
          # We are running as 'runner'. So we need to connect as 'runner' but with principal 'testuser'.
          # SSH command in script: ssh ... testuser@$TARGET_HOST
          # We need to sed/patch the script to use current user? 
          # OR just create 'testuser' on the system?
          # creating user is cleaner.
          sudo useradd -m -s /bin/bash testuser || true
          # We need to set up auth_principals for 'testuser'
          sudo sh -c "echo 'testuser' > /etc/ssh/auth_principals/testuser"

          # Run the script
          # Pass env vars
          export CA_SERVER_URL="http://localhost:8080"
          export TARGET_HOST="localhost"

          # The script generates keys in current dir.
          # It uses `pwd`
          bash scripts/test-e2e-suite.sh

          # Cleanup
          kill $PID
