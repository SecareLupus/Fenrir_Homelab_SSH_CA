version: '3.8'
services:
  fenrir-server:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - CA_PASSPHRASE=test-passphrase
      - DB_ENCRYPTION_KEY=test-db-key
      - BIND_ADDR=:8080
      - DB_PATH=/app/data/fenrir.db
      - KEY_PATH=/app/data/ca-keys
      - CA_HARDENED_SYNC=false
      - INITIAL_ADMIN_PASSWORD=adminpassword
    volumes:
      - ca-data:/app/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/v1/health" ]
      interval: 5s
      timeout: 2s
      retries: 5

  ssh-target:
    image: alpine:latest
    privileged: true
    command: >
      sh -c "apk add --no-cache openssh-server curl &&
             ssh-keygen -A &&
             mkdir -p /root/.ssh &&
             echo 'PasswordAuthentication no' >> /etc/ssh/sshd_config &&
             echo 'PubkeyAuthentication yes' >> /etc/ssh/sshd_config &&
             echo 'TrustedUserCAKeys /etc/ssh/user_ca.pub' >> /etc/ssh/sshd_config &&
             echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config &&
             # Wait for Fenrir server, then fetch pubkey
             until curl -sf http://fenrir-server:8080/api/v1/ca/user > /etc/ssh/user_ca.pub; do sleep 1; done &&
             # Create a test user for SSH (ignore if exists)
             id -u testuser &>/dev/null || adduser -D testuser &&
             passwd -d testuser &&
             /usr/sbin/sshd -D -e"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "22"]
      interval: 2s
      timeout: 2s
      retries: 30

  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - CA_SERVER_URL=http://fenrir-server:8080
      - TARGET_HOST=ssh-target
    entrypoint: [ "./test-e2e-suite.sh" ]
    depends_on:
      fenrir-server:
        condition: service_healthy
      ssh-target:
        condition: service_healthy

volumes:
  ca-data:
